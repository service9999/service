import{expect as t}from"chai";import e from"@bitcoin-computer/bitcore-mnemonic-ltc";e.bitcore;const{CHAIN:r,NETWORK:n,BCN_URL:o,RPC_USER:a,RPC_PASSWORD:s,TEST_MNEMONICS:c}=process.env;const i=r||"LTC";const f=n||"testnet";parseInt(process.env.BC_DUST_LIMIT||"",10),parseInt(process.env.BC_DEFAULT_FEE||"",10),parseInt(process.env.BC_SCRIPT_CHUNK_SIZE||"",10),parseInt(process.env.MWEB_HEIGHT||"",10);const{PublicKey:p,crypto:u}=e.bitcore;const{Point:d}=u;function l(t){return Buffer.from(t,"hex").toString().replace(/\0/g,"")}function S(t,e,r){if(t.length*Math.log2(e)>53)throw new Error(`Input too large ${t.length} ${Math.log2(e)}`);if(![2,10,16].includes(e)||![2,10,16].includes(r))throw new Error("ToBase or FromBase invalid in covertNumber.");if(2===e&&t.length%8!=0)throw new Error("Binary strings must be byte aligned.");if(16===e&&t.length%2!=0)throw new Error("Hex strings must be of even length.");const n=parseInt(t,e).toString(r);return 2===r?n.padStart(8*Math.ceil(n.length/8),"0"):16===r?n.padStart(2*Math.ceil(n.length/2),"0"):n}function g(t,e){const r=new RegExp(`.{1,${e}}`,"g");return t.match(r)||[]}function h(t){return g(t,2).map((t=>S(t,16,2))).join("")}function b(t){return g(t,8).map((t=>S(t,2,16))).join("")}function m(t){if(62!==t.length)throw new Error("Input to hexToPublicKey must be of length 62");let e=!1;let r=0;let n;for(;!e;){if(r>=256)throw new Error("Something went wrong storing data");const s=r.toString(16).padStart(2,"0")+b((a=r,(o=h(t).padStart(64,"0")).slice(a)+o.slice(0,a)));try{n=d.fromX(!1,s),e=!0}catch(t){r+=1}}var o,a;if(!n)throw new Error("Something went wrong storing data");return new p(n)}function O(t){const e=t.point.getX().toString("hex").padStart(64,"0");const r=S(e.slice(0,2),16,10);return b((o=parseInt(r,10),(n=h(e.slice(2))).slice(-o)+n.slice(0,-o)));var n,o}function _(t=i,e=f){if("testnet"===e||"regtest"===e)return 1;if("BTC"===t)return 0;if("LTC"===t)return 2;if("DOGE"===t)return 3;if("BCH"===t)return 145;if("BSV"===t)return 236;throw new Error(`Unsupported chain ${t}`)}function C({chain:t=i,network:e=f}={}){return function({purpose:t=44,coinType:e=2,account:r=0}={}){return`m/${t.toString()}'/${e.toString()}'/${r.toString()}'`}({coinType:_(t,e)})}function P(t,r){const n=function(t,r){return((t,e,r={})=>{const{path:n="m/44'/0'/0'/0",passphrase:o=""}=r;let a=t.toHDPrivateKey(o,e);return n&&(a=a.deriveChild(n)),a.privateKey})(new e("replace this seed"),r,{path:C({chain:t,network:r}),passphrase:""})}(t,r);return p.fromPrivateKey(n)}const{PublicKey:y,Script:I}=e.bitcore;function E(t,e,r,n){const o=n?[...t,P(e,r).toBuffer()]:t;const a=new I;return a.add("OP_1"),o.forEach((t=>{a.add(t)})),a.add(`OP_${o.length}`),a.add("OP_CHECKMULTISIG"),a}function T(t,e){const r=t.chunks.filter((t=>t.buf));return(e?r.slice(0,-1):r).map((t=>t.buf))}function w(t,e,r,n){if(t.length>3)throw new Error("Too many owners");return E(t.map((t=>t.toBuffer())),e,r,n)}function M(t,e){return T(t,e).map((t=>y.fromBuffer(t)))}function q(t,e,r,n){var o;return function(t,e){const r=[];for(let n=0;n<t.length;n+=e)r.push(t.slice(n,n+e));return r}(g((o=t,Buffer.from(o).toString("hex")),62).map((t=>t.padStart(62,"0"))).map(m),n?2:3).map((t=>w(t,e,r,n)))}function K(t,e){return t.map((t=>M(t,e))).flat().map(O).map(l).join("")}describe("Script",(()=>{describe("bufsToScript",(()=>{it("should create a script from an array of buffers when anyOneCanSpend is true",(()=>{const e=E([Buffer.from("1"),Buffer.from("2"),Buffer.from("3")],i,f,!1);t(e.toASM()).eq("OP_1 31 32 33 OP_3 OP_CHECKMULTISIG")}))})),describe("scriptToBufs",(()=>{it("should create a an array of buffers from a script when anyOneCanSpend is false",(()=>{const e=[Buffer.from("1"),Buffer.from("2"),Buffer.from("3")];const r=T(E(e,i,f,!1),!1);t(r).to.deep.eq(e)}))})),describe("publicKeysToScript",(()=>{it("should create a script from an array of buffers",(()=>{const e=w(["1","2","3"].map((t=>t.padStart(62,"0"))).map(m),i,f,!1);t(e.toASM()).eq("OP_1 020000000000000000000000000000000000000000000000000000000000000001 020000000000000000000000000000000000000000000000000000000000000002 020000000000000000000000000000000000000000000000000000000000000003 OP_3 OP_CHECKMULTISIG")}))})),describe("scriptToPublicKeys",(()=>{it("should create a script from an array of buffers",(()=>{const e=["1","2","3"].map((t=>t.padStart(62,"0"))).map(m);const r=M(w(e,i,f,!1),!1);t(r.length).eq(e.length),t(r[0].toString()).eq(e[0].toString()),t(r[1].toString()).eq(e[1].toString()),t(r[2].toString()).eq(e[2].toString())}))})),describe("stringToScripts",(()=>{it("should create a script from a json object",(()=>{const e={a:"1".repeat(85)};const r=q(JSON.stringify(e),i,f,!1);t(r.length).eq(1);const[n]=r;t(n.toASM()).eq("OP_1 0203d9130911d1118989898989898989898989898989898989898989898989898b 020162626262626262626262626262626262626262626262626262626262626262 02003131313131313131313131313131313131313131313131313131313131227d OP_3 OP_CHECKMULTISIG")})),it("should create a script from a large json object",(()=>{const e={a:"1".repeat(86)};const r=q(JSON.stringify(e),i,f,!1);t(r.length).eq(2),t(r[0].toASM()).eq("OP_1 0203d9130911d1118989898989898989898989898989898989898989898989898b 020162626262626262626262626262626262626262626262626262626262626262 020162626262626262626262626262626262626262626262626262626262626244 OP_3 OP_CHECKMULTISIG"),t(r[1].toASM()).eq("OP_1 0201000000000000000000000000000000000000000000000000000000000000fa OP_1 OP_CHECKMULTISIG")})),it("should create a script from a json object using anyOneCanSpend publicKey",(()=>{const e={a:"1".repeat(85)};const r=q(JSON.stringify(e),i,f,!0);t(r.length).eq(2),t(r[0].toASM()).eq("OP_1 0203d9130911d1118989898989898989898989898989898989898989898989898b 020162626262626262626262626262626262626262626262626262626262626262 03d92bbbd61e057a68d266ba234842393c03455e8eda5df591ab1d344b1d30d029 OP_3 OP_CHECKMULTISIG"),t(r[1].toASM()).eq("OP_1 02003131313131313131313131313131313131313131313131313131313131227d 03d92bbbd61e057a68d266ba234842393c03455e8eda5df591ab1d344b1d30d029 OP_2 OP_CHECKMULTISIG")})),it("should create a script from a large json object using anyOneCanSpend publicKey",(()=>{const e={a:"1".repeat(86)};const r=q(JSON.stringify(e),i,f,!0);t(r.length).eq(2),t(r[0].toASM()).eq("OP_1 0203d9130911d1118989898989898989898989898989898989898989898989898b 020162626262626262626262626262626262626262626262626262626262626262 03d92bbbd61e057a68d266ba234842393c03455e8eda5df591ab1d344b1d30d029 OP_3 OP_CHECKMULTISIG"),t(r[1].toASM()).eq("OP_1 020162626262626262626262626262626262626262626262626262626262626244 0201000000000000000000000000000000000000000000000000000000000000fa 03d92bbbd61e057a68d266ba234842393c03455e8eda5df591ab1d344b1d30d029 OP_3 OP_CHECKMULTISIG")}))})),describe("scriptsToString",(()=>{it("should create a json object from a script",(()=>{const e={a:"1".repeat(85)};const r=q(JSON.stringify(e),i,f,!1);t(r.length).eq(1);const n=K(r,!1);const o=JSON.parse(n);t(o).to.deep.eq(e)})),it("should create a large json object from an array of script",(()=>{const e={a:"1".repeat(86)};const r=q(JSON.stringify(e),i,f,!1);t(r.length).eq(2);const n=K(r,!1);const o=JSON.parse(n);t(o).to.deep.eq(e)})),it("should create a json object from a script using anyOneCanSpend publicKey",(()=>{const e={a:"1".repeat(85)};const r=q(JSON.stringify(e),i,f,!0);t(r.length).eq(2);const n=K(r,!0);const o=JSON.parse(n);t(o).to.deep.eq(e)})),it("should create a large json object from an array of script using anyOneCanSpend publicKey",(()=>{const e={a:"1".repeat(86)};const r=q(JSON.stringify(e),i,f,!0);t(r.length).eq(2);const n=K(r,!0);const o=JSON.parse(n);t(o).to.deep.eq(e)}))}))}));
