import t from"chai";import e from"sinon";import r from"sinon-chai";import o from"pg-promise";import n from"pg-monitor";import"exponential-backoff";import s from"dotenv";import i from"is-primitive";import a from"is-plain-object";import l from"fs";import c from"os";import{dirname as f}from"path";import{fileURLToPath as u}from"url";import{createLogger as p,format as m,transports as y}from"winston";const{deleteProperty:h}=Reflect;const d=i;const g=a;const v=t=>"object"==typeof t&&null!==t||"function"==typeof t;const b=t=>{if(!d(t))throw new TypeError("Object keys must be strings or symbols");if((t=>"__proto__"===t||"constructor"===t||"prototype"===t)(t))throw new Error(`Cannot set unsafe key: "${t}"`)};const S=(t,e)=>e&&"function"==typeof e.split?e.split(t):"symbol"==typeof t?[t]:Array.isArray(t)?t:((t,e,r)=>{const o=(t=>Array.isArray(t)?t.flat().map(String).join(","):t)(e?((t,e)=>{if("string"!=typeof t||!e)return t;let r=t+";";return void 0!==e.arrays&&(r+=`arrays=${e.arrays};`),void 0!==e.separator&&(r+=`separator=${e.separator};`),void 0!==e.split&&(r+=`split=${e.split};`),void 0!==e.merge&&(r+=`merge=${e.merge};`),void 0!==e.preservePaths&&(r+=`preservePaths=${e.preservePaths};`),r})(t,e):t);b(o);const n=E.cache.get(o)||r();return E.cache.set(o,n),n})(t,e,(()=>((t,e={})=>{const r=e.separator||".";const o="/"!==r&&e.preservePaths;if("string"==typeof t&&!1!==o&&/\//.test(t))return[t];const n=[];let s="";const i=t=>{let e;""!==t.trim()&&Number.isInteger(e=Number(t))?n.push(e):n.push(t)};for(let e=0;e<t.length;e++){const o=t[e];"\\"!==o?o!==r?s+=o:(i(s),s=""):s+=t[++e]}return s&&i(s),n})(t,e)));const _=(t,e,r,o)=>{if(b(e),void 0===r)h(t,e);else if(o&&o.merge){const n="function"===o.merge?o.merge:Object.assign;n&&g(t[e])&&g(r)?t[e]=n(t[e],r):t[e]=r}else t[e]=r;return t};const E=(t,e,r,o)=>{if(!e||!v(t))return t;const n=S(e,o);let s=t;for(let t=0;t<n.length;t++){const e=n[t];const i=n[t+1];if(b(e),void 0===i){_(s,e,r,o);break}"number"!=typeof i||Array.isArray(s[e])?(v(s[e])||(s[e]={}),s=s[e]):s=s[e]=[]}return t};E.split=S,E.cache=new Map,E.clear=()=>{E.cache=new Map};var w=E;var R=l;var O="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};var T="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};var P=function(){function t(t,e){for(var r=0;r<e.length;r++){var o=e[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,r,o){return r&&t(e.prototype,r),o&&t(e,o),e}}();var A=function t(e,r){var o=r.indexOf(".");if(!~o){if(null==e)return;return e[r]}var n=r.substring(0,o),s=r.substring(o+1);if(null!=e)return e=e[n],s?t(e,s):e},C=w,N=function(t,e){if("function"!=typeof e)return JSON.parse(R.readFileSync(t));R.readFile(t,"utf-8",(function(t,r){try{r=JSON.parse(r)}catch(e){t=t||e}e(t,r)}))},M=l,$=c;var x=function(){function t(e,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.options=r=r||{},r.stringify_width=r.stringify_width||2,r.stringify_fn=r.stringify_fn||null,r.stringify_eol=r.stringify_eol||!1,r.ignore_dots=r.ignore_dots||!1,this.path=e,this.data=this.read()}return P(t,[{key:"set",value:function(t,e,r){var o=this;return"object"===(void 0===t?"undefined":T(t))?function(t,e){var r=0,o=[];if(Array.isArray(t))for(;r<t.length&&!1!==e(t[r],r);++r);else if("object"===(void 0===t?"undefined":O(t))&&null!==t)for(o=Object.keys(t);r<o.length&&!1!==e(t[o[r]],o[r]);++r);}(t,(function(t,e){C(o.data,e,t,r)})):this.options.ignore_dots?this.data[t]=e:C(this.data,t,e,r),this.options.autosave&&this.save(),this}},{key:"get",value:function(t){return t?this.options.ignore_dots?this.data[t]:A(this.data,t):this.toObject()}},{key:"unset",value:function(t){return this.set(t,void 0)}},{key:"append",value:function(t,e){var r=this.get(t);if(r=void 0===r?[]:r,!Array.isArray(r))throw new Error("The data is not an array!");return r.push(e),this.set(t,r),this}},{key:"pop",value:function(t){var e=this.get(t);if(!Array.isArray(e))throw new Error("The data is not an array!");return e.pop(),this.set(t,e),this}},{key:"read",value:function(t){if(!t)try{return N(this.path)}catch(t){return{}}N(this.path,(function(e,r){t(null,r=e?{}:r)}))}},{key:"write",value:function(t,e){return e?M.writeFile(this.path,t,e):M.writeFileSync(this.path,t),this}},{key:"empty",value:function(t){return this.write("{}",t)}},{key:"save",value:function(t){var e=JSON.stringify(this.data,this.options.stringify_fn,this.options.stringify_width,this.options.stringify_eol);return this.write(this.options.stringify_eol?e+$.EOL:e,t),this}},{key:"toObject",value:function(){return this.data}}]),t}();s.config();const H=new x(`${f(u(import.meta.url))}/../../package.json`,{stringify_eol:!0});const{PORT:k,ZMQ_URL:F,CHAIN:B,NETWORK:I,BCN_ENV:j,BCN_URL:U,DEBUG_MODE:D,POSTGRES_USER:G,POSTGRES_PASSWORD:L,POSTGRES_DB:W,POSTGRES_HOST:Y,POSTGRES_PORT:J,RPC_PROTOCOL:V,RPC_USER:X,RPC_PASSWORD:K,RPC_HOST:z,RPC_PORT:q,SERVER_VERSION:Q,DEFAULT_WALLET:Z,SYNC_HEIGHT:tt,SYNC_INTERVAL_CHECK:et,POSTGRES_MAX_PARAM_NUM:rt,DB_CONNECTION_RETRY_TIME:ot,SIGNATURE_FRESHNESS_MINUTES:nt,ALLOWED_RPC_METHODS:st,NODE_MAX_PROGRESS:at,SYNC_MAX_PROGRESS:lt,MWEB_HEIGHT:ct,BCDB_START_HEIGHT:ft}=process.env;const ut=j||"dev";const pt=parseInt(D,10)||1;const mt=G||"bcn";const yt=L||"bcn";const ht=W||"bcn";const dt=Y||"127.0.0.1";const gt=parseInt(J,10)||"5432";Q||H.get("version"),!st||st.split(",").map((t=>new RegExp(t)));const vt=p({level:["error","warn","info","http","verbose","debug","silly"][pt],format:m.json(),transports:[new y.Console({format:m.combine(m.colorize(),m.timestamp({format:"MM-DD-YYYY HH:mm:ss"}),m.printf((t=>`[2m${t.timestamp}[0m ${t.level} ${t.message}`)))})],exceptionHandlers:[new y.File({filename:"logs/exceptions.log"})],rejectionHandlers:[new y.File({filename:"logs/rejections.log"})]});const bt={maxFiles:1,maxSize:1e5};pt>=0&&vt.add(new y.File({filename:"error.log",level:"error"})),pt>=1&&vt.add(new y.File({filename:"logs/warn.log",level:"warn",...bt})),pt>=2&&vt.add(new y.File({filename:"logs/info.log",level:"info",...bt})),pt>=3&&vt.add(new y.File({filename:"logs/http.log",level:"http",...bt})),pt>=4&&vt.add(new y.File({filename:"logs/verbose.log",level:"verbose",...bt})),pt>=5&&vt.add(new y.File({filename:"logs/debug.log",level:"debug",...bt}));const St={error:(t,e)=>{if(e.cn){const{host:r,port:o,database:n,user:s,password:i}=e.cn;vt.debug(`Waiting for db to start { message:${t.message} host:${r}, port:${o}, database:${n}, user:${s}, password: ${i}`)}},noWarnings:!0};"dev"===ut&&pt>0&&(n.isAttached()?n.detach():(n.attach(St),n.setTheme("matrix")));const _t=o(St)({host:dt,port:gt,database:ht,user:mt,password:yt,allowExitOnIdle:!0,idleTimeoutMillis:100});const{PreparedStatement:Et}=o;class wt{static async getBalance(t){const e=new Et({name:`Utxos.getBalance.${Math.random()}`,text:'SELECT sum("satoshis") as "satoshis" FROM "Utxos" WHERE "address" = $1',values:[t]});const r=await _t.oneOrNone(e);return parseInt(r?.satoshis,10)||0}static async select(t){const e=new Et({name:`Utxos.select.${Math.random()}`,text:'SELECT "address", "satoshis", "scriptPubKey", "rev" FROM "Utxos" WHERE "address" = $1',values:[t]});return(await _t.any(e)).map((t=>({...t,satoshis:parseInt(t.satoshis,10)||0})))}}class Rt{static async getBalance(t){return wt.getBalance(t)}static async select(t){return wt.select(t)}}t.use(r);const{expect:Ot}=t;describe("services",(()=>{describe("Utxo.service",(()=>{it("Should return the balance of an address",(async()=>{const t="1C9UbB9P8Jba21mLiEXio14eRg8cBn9wyx";const r=e.stub(Rt,"getBalance").resolves(100);const o=await Rt.getBalance(t);Ot(r.calledWith(t)).to.be.true,Ot(o).eq(100),r.restore()}))}))}));
